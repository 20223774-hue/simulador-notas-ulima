<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador de Notas ULima</title>

  <style>
    :root{
      --bg:#f3f5fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow:0 16px 40px rgba(15,23,42,.10);
      --shadow2:0 10px 24px rgba(15,23,42,.08);
      --radius:18px;

      --primary:#2563eb;
      --primary2:#1d4ed8;
      --ok:#16a34a;
      --bad:#dc2626;

      --tableHead:#f8fafc;
      --rowA:#ffffff;
      --rowB:#f8fafc;
      --hover:#eef2ff;

      --pillBg:#eef2ff;
      --pillText:#3730a3;
      --focus: rgba(59,130,246,.18);
    }

    html[data-theme="dark"]{
      --bg:#0b1020;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#223048;
      --shadow:0 16px 40px rgba(0,0,0,.45);
      --shadow2:0 10px 24px rgba(0,0,0,.35);

      --primary:#60a5fa;
      --primary2:#3b82f6;
      --ok:#34d399;
      --bad:#fb7185;

      --tableHead:#0b1220;
      --rowA:#0f172a;
      --rowB:#0b1220;
      --hover:#111c33;

      --pillBg:#111c33;
      --pillText:#c7d2fe;
      --focus: rgba(96,165,250,.18);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      padding:24px;
      color:var(--text);
    }

    .box{
      max-width:1200px;
      margin:auto;
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }

    body.inicio-activo{
      padding:0;
    }

    body.inicio-activo .box{
      max-width:none;
      margin:0;
      padding:0;
      background:transparent;
      border:none;
      box-shadow:none;
    }

    body.inicio-activo .inicio{
      min-height:100vh;
      border-radius:0;
    }

    .inicio{
      position:relative;
      min-height: calc(100vh - 48px);
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(circle at top, rgba(255,255,255,.7), rgba(243,245,251,.92)),
        linear-gradient(135deg, rgba(255,255,255,.9), rgba(237,242,250,.95));
      border-radius:24px;
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }

    html[data-theme="dark"] .inicio{
      background: radial-gradient(circle at top, rgba(30,41,59,.6), rgba(11,16,32,.95)),
        linear-gradient(135deg, rgba(15,23,42,.95), rgba(2,6,23,.92));
    }

    #mathCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      opacity:.8;
    }

    .inicio-content{
      position:relative;
      text-align:center;
      padding:32px 36px;
      border-radius:24px;
      backdrop-filter: blur(18px);
      background: rgba(255,255,255,.7);
      border:1px solid rgba(226,232,240,.8);
      box-shadow: 0 20px 50px rgba(15,23,42,.12);
      max-width:520px;
    }

    html[data-theme="dark"] .inicio-content{
      background: rgba(15,23,42,.75);
      border-color: rgba(51,65,85,.75);
      box-shadow: 0 20px 50px rgba(0,0,0,.45);
    }

    .inicio-title{
      font-size:28px;
      margin:0;
      letter-spacing:.5px;
    }

    .inicio-actions{
      margin-top:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }

    .btn-start{
      padding:12px 24px;
      border-radius:999px;
      border:1px solid transparent;
      background: linear-gradient(135deg, #0f172a, #334155);
      color:white;
      font-weight:800;
      letter-spacing:.3px;
      box-shadow: 0 16px 30px rgba(15,23,42,.25);
    }

    html[data-theme="dark"] .btn-start{
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      box-shadow: 0 16px 30px rgba(59,130,246,.25);
    }

    .btn-secondary{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      font-weight:800;
      letter-spacing:.3px;
      padding:12px 24px;
      border-radius:999px;
      box-shadow: 0 12px 24px rgba(15,23,42,.12);
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
      flex-wrap:wrap;
    }

    .topbar-actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
    }

    h2{ margin:0; font-size:22px; }
    .subtitle{ font-size:13px; color:var(--muted); margin-top:6px; line-height:1.35; }
    .creator{ font-size:12px; color:var(--muted); margin-top:4px; }

    .hint{
      margin-top:14px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      font-size:13px;
      color:var(--muted);
      line-height:1.45;
    }

    .controls{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      box-shadow:var(--shadow2);
    }

    label{
      font-size:13px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    input{
      width:120px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-weight:600;
    }

    /* iPhone: evita zoom al tocar inputs */
    input, button { font-size:16px; }

    input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 4px var(--focus);
    }

    button{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      cursor:pointer;
      font-weight:800;
      color:var(--text);
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }

    button:hover{ transform: translateY(-1px); }
    button:active{ transform: translateY(0); }

    .btn-primary{
      background:var(--primary);
      border-color:var(--primary);
      color:white;
    }
    .btn-primary:hover{ background:var(--primary2); border-color:var(--primary2); }

    .btn-ghost{ opacity:.85; }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }

    .sim-grid{
      display:grid;
      grid-template-columns: 0.9fr 1.1fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }

    .summary-card{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow2);
    }

    .summary-card h3{
      margin:0 0 10px;
      font-size:16px;
    }

    .mini-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }

    .mini-table th,
    .mini-table td{
      text-align:left;
      padding:6px 8px;
      border-bottom:1px dashed var(--border);
    }

    .tableWrap{
      overflow:auto;
      border-radius:16px;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      min-width: 520px; /* ayuda al scroll en m√≥vil */
    }

    th, td{
      padding:10px;
      font-size:13px;
      border-bottom:1px solid var(--border);
      text-align:center;
      white-space:nowrap;
    }

    th{
      background:var(--tableHead);
      font-weight:900;
      position:sticky;
      top:0;
      z-index:1;
    }

    tbody tr:nth-child(odd) td{ background:var(--rowA); }
    tbody tr:nth-child(even) td{ background:var(--rowB); }
    tbody tr:hover td{ background:var(--hover); }

    .ok{ color:var(--ok); font-weight:900; }
    .bad{ color:var(--bad); font-weight:900; }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      background:var(--pillBg);
      color:var(--pillText);
      font-weight:900;
      white-space:nowrap;
    }

    .course-grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }

    .course-section{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow2);
      background:var(--card);
    }

    .course-section h3{
      margin:0 0 12px;
      font-size:16px;
    }

    .course-card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      margin-bottom:12px;
      background:var(--rowA);
    }

    .course-card h4{
      margin:0 0 10px;
      font-size:14px;
    }

    .checkbox-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px 16px;
    }

    .course-item{
      display:flex;
      gap:12px;
      align-items:flex-start;
      font-size:13px;
      color:var(--text);
      white-space:normal;
    }

    .course-item input{
      width:auto;
      margin-top:3px;
    }

    .course-meta{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .course-meta span{
      font-weight:700;
      line-height:1.5;
      word-break:break-word;
      white-space:normal;
    }

    .course-meta small{
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
      word-break:break-word;
      white-space:normal;
    }

    .course-results{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .course-list{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .course-list li{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:var(--rowA);
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .course-list li strong{
      line-height:1.5;
      word-break:break-word;
    }

    .course-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .course-reqs{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
      word-break:break-word;
    }

    .req-list{
      margin:6px 0 0;
      padding-left:18px;
      display:flex;
      flex-direction:column;
      gap:6px;
      line-height:1.45;
    }

    .req-list li{
      margin:0;
    }

    .course-empty{
      padding:12px;
      border-radius:12px;
      border:1px dashed var(--border);
      color:var(--muted);
      font-size:13px;
    }

    /* ‚úÖ Responsive para celular */
    @media (max-width: 900px){
      body{ padding:14px; }
      .box{ padding:14px; }
      .grid,
      .sim-grid,
      .course-grid{ grid-template-columns: 1fr; }
      .inicio{ min-height: calc(100vh - 28px); }
      .inicio-content{ padding:24px; }
      .controls{ gap:8px; }
      label{ width:100%; justify-content:space-between; }
      input{ width:140px; }
      /* botones full width en m√≥vil */
      .controls button{ width:100%; }
      .topbar-actions{ width:100%; align-items:stretch; }
      .topbar-actions button{ width:100%; }
    }

    /* PDF */
    @media print{
      html[data-theme="dark"]{
        --bg:white; --card:white; --text:#0f172a; --muted:#64748b; --border:#e2e8f0;
        --tableHead:#f8fafc; --rowA:#ffffff; --rowB:#f8fafc; --hover:#eef2ff;
      }
      body{ padding:0; }
      button,.controls{ display:none!important; }
      .box{ box-shadow:none; border:none; }
      input{ border:none; }
    }
  </style>
</head>

<body>
<div class="box">

  <section id="vistaInicio">
    <div class="inicio">
      <canvas id="mathCanvas" aria-hidden="true"></canvas>
      <div class="inicio-content">
        <div class="inicio-actions">
          <button class="btn-start" onclick="iniciarSimulador()">Ingresar a simulador de notas</button>
          <button class="btn-secondary" onclick="iniciarSimuladorCursos()">üìò Simulador de cursos</button>
        </div>
      </div>
    </div>
  </section>

  <section id="vistaEntrada" style="display:none;">
    <div class="topbar">
      <div>
        <h2>Simulador de Notas ULima (para no repetir el ciclo)</h2>
        <div class="subtitle">Aprobaci√≥n 10.5 ¬∑ Notas 1‚Äì20 ¬∑ El promedio no perdona</div>
        <div class="creator">Creador: Sebasti√°n Mory Ricse</div>
      </div>
      <div class="topbar-actions">
        <button class="btn-ghost btn-theme" onclick="toggleTheme()">üåô Dark mode</button>
        <button class="btn-secondary" onclick="volverInicio()">Inicia</button>
      </div>
    </div>

    <div class="hint">
      Ingresa tus notas conocidas. Si a√∫n no tienes nota, deja el campo vac√≠o pero indica el porcentaje.
    </div>

    <div class="controls">
      <button onclick="agregarFila()">Agregar fila</button>
      <button onclick="calcular()">Calcular promedio</button>

      <label>Hasta:
        <input id="hastaProm" type="number" min="10.5" max="20" step="0.5" value="20">
      </label>
      <label>Paso:
        <input id="pasoProm" type="number" min="0.5" max="2" step="0.5" value="0.5">
      </label>

      <button class="btn-primary" onclick="correrSimulacion()">Correr simulaci√≥n</button>
      <button onclick="window.print()">Guardar PDF</button>
    </div>

    <div class="grid">
      <div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Nota</th>
                <th>%</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tabla"></tbody>
          </table>
        </div>

        <h3>Promedio: <span id="resultado">‚Äî</span></h3>
        <h3 id="estado"></h3>
        <div class="small" id="mensajeExtra"></div>
      </div>
    </div>
  </section>

  <section id="vistaSimulacion" style="display:none;">
    <div class="topbar">
      <div>
        <h2>Simulador de Notas ULima (para no repetir el ciclo)</h2>
        <div class="subtitle">Aprobaci√≥n 10.5 ¬∑ Notas 1‚Äì20 ¬∑ El promedio no perdona</div>
        <div class="creator">Creador: Sebasti√°n Mory Ricse</div>
      </div>
      <div class="topbar-actions">
        <button class="btn-ghost btn-theme" onclick="toggleTheme()">üåô Dark mode</button>
        <button class="btn-secondary" onclick="volverInicio()">Inicia</button>
      </div>
    </div>

    <div class="controls">
      <button onclick="volverEdicion()">‚Üê Volver a editar</button>
      <button class="btn-primary" onclick="correrSimulacion()">Actualizar simulaci√≥n</button>
      <button onclick="window.print()">Guardar PDF</button>
    </div>

    <div class="sim-grid">
      <div class="summary-card">
        <h3>Miniatura de tus datos</h3>
        <table class="mini-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Nota</th>
              <th>%</th>
            </tr>
          </thead>
          <tbody id="miniaturaDatos"></tbody>
        </table>
        <div class="small" id="miniaturaMensaje"></div>
      </div>

      <div>
        <div class="tableWrap">
          <table>
            <thead id="escHead"></thead>
            <tbody id="escenarios"></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:10px;">
          Tip: en celular puedes deslizar la tabla de simulaci√≥n hacia los lados.
        </div>
      </div>
    </div>
  </section>

  <section id="vistaCursos" style="display:none;">
    <div class="topbar">
      <div>
        <h2>Simulador de cursos ULima</h2>
        <div class="subtitle">Marca los cursos que ya aprobaste y descubre los que puedes llevar.</div>
        <div class="creator">Creador: Sebasti√°n Mory Ricse</div>
      </div>
      <div class="topbar-actions">
        <button class="btn-ghost btn-theme" onclick="toggleTheme()">üåô Dark mode</button>
        <button class="btn-secondary" onclick="volverInicio()">Inicia</button>
      </div>
    </div>

    <div class="hint">
      Los cr√©ditos y el nivel de ciclo se calculan autom√°ticamente seg√∫n los cursos aprobados.
    </div>

    <div class="controls">
      <label>Cr√©ditos aprobados (auto)
        <input id="creditosAprobados" type="number" min="0" max="250" step="1" value="0" readonly>
      </label>
      <label>Nivel de ciclo (auto)
        <input id="nivelCulminado" type="number" min="0" max="10" step="1" value="1" readonly>
      </label>
      <button class="btn-primary" onclick="simularCursos()">Simular cursos disponibles</button>
      <button onclick="limpiarCursos()">Limpiar selecci√≥n</button>
    </div>

    <div class="course-grid">
      <div class="course-section">
        <h3>‚úÖ Cursos aprobados</h3>
        <div id="courseChecklist"></div>
      </div>
      <div class="course-section course-results">
        <div>
          <h3>üìò Obligatorias disponibles</h3>
          <ul class="course-list" id="resultadoObligatorios"></ul>
          <div class="course-empty" id="emptyObligatorios" style="display:none;">
            A√∫n no hay cursos obligatorios disponibles con los requisitos actuales.
          </div>
        </div>
        <div>
          <h3>üéì Electivos disponibles</h3>
          <ul class="course-list" id="resultadoElectivos"></ul>
          <div class="course-empty" id="emptyElectivos" style="display:none;">
            A√∫n no hay cursos electivos disponibles con los requisitos actuales.
          </div>
        </div>
      </div>
    </div>
  </section>

</div>

<script>
  const APROBACION = 10.5;
  const tabla = document.getElementById("tabla");
  const canvas = document.getElementById("mathCanvas");
  const ctx = canvas.getContext("2d");
  const symbols = ["‚àë","œÄ","‚àö","Œî","‚à´","‚àû","+","‚àí","√ó","√∑","=","x","y","z","sin","cos","tan","log","‚àÇ","‚âà","‚â†","‚â§","‚â•","Œª","Œº","œÉ","œÜ","Œ≤","Œ∏","‚àá","1","2","3","4","5","6","7","8","9","0"];
  const particles = [];
  const maxParticles = 90;
  const mouse = { x: -9999, y: -9999, active: false };

  function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);
    document.querySelectorAll(".btn-theme").forEach((btn) => {
      btn.textContent = (theme === "dark") ? "‚òÄÔ∏è Modo claro" : "üåô Dark mode";
    });
  }

  function toggleTheme(){
    const cur = document.documentElement.getAttribute("data-theme") || "light";
    applyTheme(cur==="dark" ? "light" : "dark");
  }

  (function initTheme(){
    const saved = localStorage.getItem("theme");
    applyTheme(saved || "light");
  })();

  function resizeCanvas(){
    const rect = canvas.parentElement.getBoundingClientRect();
    const ratio = window.devicePixelRatio || 1;
    canvas.width = rect.width * ratio;
    canvas.height = rect.height * ratio;
    canvas.style.width = `${rect.width}px`;
    canvas.style.height = `${rect.height}px`;
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
  }

  function createParticle(){
    const rect = canvas.getBoundingClientRect();
    return {
      x: Math.random() * rect.width,
      y: Math.random() * -rect.height,
      speed: 0.3 + Math.random() * 1.4,
      size: 10 + Math.random() * 14,
      symbol: symbols[Math.floor(Math.random() * symbols.length)],
      opacity: 0.15 + Math.random() * 0.6
    };
  }

  function updateParticles(){
    const rect = canvas.getBoundingClientRect();
    ctx.clearRect(0, 0, rect.width, rect.height);
    ctx.font = "14px system-ui, sans-serif";

    particles.forEach(p => {
      p.y += p.speed;
      const dx = p.x - mouse.x;
      const dy = p.y - mouse.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if(mouse.active && dist < 120){
        p.x += dx * 0.008;
        p.y += dy * 0.008;
      }
      if(p.y > rect.height + 20){
        p.y = -20;
        p.x = Math.random() * rect.width;
      }

      ctx.save();
      ctx.globalAlpha = p.opacity;
      ctx.font = `${p.size}px system-ui, sans-serif`;
      ctx.fillStyle = document.documentElement.getAttribute("data-theme") === "dark"
        ? "rgba(148,163,184,0.7)"
        : "rgba(15,23,42,0.5)";
      ctx.fillText(p.symbol, p.x, p.y);
      ctx.restore();
    });

    requestAnimationFrame(updateParticles);
  }

  function initParticles(){
    particles.length = 0;
    for(let i = 0; i < maxParticles; i++){
      particles.push(createParticle());
    }
  }

  function setupCanvas(){
    resizeCanvas();
    initParticles();
  }

  window.addEventListener("resize", () => {
    resizeCanvas();
    initParticles();
  });

  window.addEventListener("mousemove", (event) => {
    const rect = canvas.getBoundingClientRect();
    mouse.x = event.clientX - rect.left;
    mouse.y = event.clientY - rect.top;
    mouse.active = true;
  });

  window.addEventListener("mouseleave", () => {
    mouse.active = false;
  });

  function agregarFila(nota="", porcentaje=""){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="number" min="1" max="20" step="1" value="${nota}" placeholder="Ej: 14"></td>
      <td><input type="number" min="0" max="100" step="0.01" value="${porcentaje}" placeholder="Ej: 20"></td>
      <td><button onclick="this.closest('tr').remove(); calcular();">‚úñ</button></td>`;
    tabla.appendChild(tr);
  }

  // filas iniciales
  agregarFila(); agregarFila(); agregarFila();

  function leer(){
    return [...tabla.querySelectorAll("tr")].map(r=>{
      const i=r.querySelectorAll("input");
      const notaStr = i[0].value.trim();
      const porcStr = i[1].value.trim();
      return {
        nota: notaStr==="" ? null : Number(notaStr),
        p: porcStr==="" ? 0 : Number(porcStr)
      };
    }).filter(x => x.nota !== null || x.p !== 0);
  }

  function calcular(){
    const it = leer();
    let suma = 0, total = 0, sumaConocidas = 0;

    it.forEach(x=>{
      total += x.p;
      if(x.nota !== null){
        suma += x.nota * x.p / 100;
        sumaConocidas += x.p;
      }
    });

    document.getElementById("resultado").textContent = suma.toFixed(2);
    document.getElementById("estado").innerHTML =
      suma >= APROBACION ? '<span class="ok">APROBADO ‚úÖ</span>' : '<span class="bad">NO APROBADO ‚ùå</span>';

    const msg = document.getElementById("mensajeExtra");
    if(total < 100){
      msg.textContent = `Te falta completar ${(100-total).toFixed(2)}% de porcentajes.`;
      msg.className = "small";
    } else if(total > 100.0001){
      msg.textContent = `Ojo: tus porcentajes suman ${total.toFixed(2)}% (deber√≠a ser 100%).`;
      msg.className = "small bad";
    } else {
      msg.textContent = "";
      msg.className = "small";
    }
  }

  function correrSimulacion(){
    const it = leer();
    const total = it.reduce((a,x)=>a+x.p,0);
    if(total > 100.0001){
      alert("Tus porcentajes suman m√°s de 100%. Corrige eso.");
      return;
    }

    const pend = it.filter(x=>x.nota==null && x.p>0);
    if(pend.length===0){
      alert("No hay evaluaciones pendientes (nota vac√≠a con %).");
      return;
    }

    let head = '<tr><th>Obj</th><th>Prom</th><th>Estado</th>';
    pend.forEach(p=> head += `<th><span class="pill">${p.p.toFixed(2)}%</span></th>`);
    head += '</tr>';
    document.getElementById("escHead").innerHTML = head;

    const tbody = document.getElementById("escenarios");
    tbody.innerHTML = "";

    const hasta = Number(document.getElementById("hastaProm").value);
    const paso  = Number(document.getElementById("pasoProm").value);

    const conocidas = it.filter(x=>x.nota!=null);
    const sumaConocidas = conocidas.reduce((a,x)=>a + x.nota * x.p / 100, 0);
    const porcPend = pend.reduce((a,x)=>a + x.p, 0);

    function generarNotas(pendientes, promedioReq){
      const redondearNota = (nota) => Math.min(20, Math.max(1, Math.round(nota)));
      if(pendientes.length === 1){
        return [redondearNota(promedioReq)];
      }

      const totalPeso = pendientes.reduce((a,x)=>a+x.p,0);
      const objetivo = promedioReq * totalPeso;
      const notas = [];
      let suma = 0;
      let pesoRestante = totalPeso;

      for(let i = 0; i < pendientes.length; i++){
        const p = pendientes[i].p;
        pesoRestante -= p;
        const minRem = 1 * pesoRestante;
        const maxRem = 20 * pesoRestante;
        const minNota = Math.max(1, (objetivo - suma - maxRem) / p);
        const maxNota = Math.min(20, (objetivo - suma - minRem) / p);
        if(minNota > maxNota || Number.isNaN(minNota) || Number.isNaN(maxNota)){
          return pendientes.map(()=> promedioReq);
        }

        const nota = i === pendientes.length - 1
          ? (objetivo - suma) / p
          : (Math.random() * (maxNota - minNota)) + minNota;
        const notaFinal = redondearNota(nota);
        notas.push(notaFinal);
        suma += notaFinal * p;
      }

      return notas;
    }

    for(let target = APROBACION; target <= hasta + 1e-9; target += paso){
      const requerido = (target - sumaConocidas) / (porcPend / 100);
      const esPosible = Number.isFinite(requerido) && requerido >= 1 && requerido <= 20;
      const notas = esPosible ? generarNotas(pend, requerido) : [];
      const sumaPend = esPosible
        ? notas.reduce((acc, n, idx)=> acc + (n * pend[idx].p / 100), 0)
        : 0;
      const promFinal = esPosible ? (sumaConocidas + sumaPend) : null;

      tbody.innerHTML += `
        <tr>
          <td>${target.toFixed(1)}</td>
          <td>${esPosible ? promFinal.toFixed(2) : '‚Äî'}</td>
          <td>${esPosible ? (promFinal>=APROBACION ? '‚úÖ' : '‚ùå') : '‚ùå'}</td>
          ${pend.map((_, idx)=>`<td>${esPosible ? notas[idx].toFixed(0) : '‚Äî'}</td>`).join("")}
        </tr>`;
    }

    calcular();
    renderMiniatura(it, total);
    mostrarVista("simulacion");
  }

  function renderMiniatura(items, total){
    const tbody = document.getElementById("miniaturaDatos");
    tbody.innerHTML = "";

    items.forEach((item, idx) => {
      const notaTexto = item.nota === null ? "‚Äî" : item.nota.toFixed(0);
      const porcTexto = item.p ? `${item.p.toFixed(2)}%` : "‚Äî";
      tbody.innerHTML += `
        <tr>
          <td>${idx + 1}</td>
          <td>${notaTexto}</td>
          <td>${porcTexto}</td>
        </tr>`;
    });

    const msg = document.getElementById("miniaturaMensaje");
    if(total < 100){
      msg.textContent = `Te falta completar ${(100-total).toFixed(2)}% de porcentajes.`;
      msg.className = "small";
    } else if(total > 100.0001){
      msg.textContent = `Ojo: tus porcentajes suman ${total.toFixed(2)}% (deber√≠a ser 100%).`;
      msg.className = "small bad";
    } else {
      msg.textContent = "Porcentajes completos (100%).";
      msg.className = "small ok";
    }
  }

  function mostrarVista(vista){
    const inicio = document.getElementById("vistaInicio");
    const entrada = document.getElementById("vistaEntrada");
    const simulacion = document.getElementById("vistaSimulacion");
    const cursos = document.getElementById("vistaCursos");
    if(vista === "simulacion"){
      inicio.style.display = "none";
      entrada.style.display = "none";
      simulacion.style.display = "block";
      cursos.style.display = "none";
    } else if(vista === "entrada"){
      inicio.style.display = "none";
      entrada.style.display = "block";
      simulacion.style.display = "none";
      cursos.style.display = "none";
    } else if(vista === "cursos"){
      inicio.style.display = "none";
      entrada.style.display = "none";
      simulacion.style.display = "none";
      cursos.style.display = "block";
    } else {
      inicio.style.display = "block";
      entrada.style.display = "none";
      simulacion.style.display = "none";
      cursos.style.display = "none";
    }
    document.body.classList.toggle("inicio-activo", vista === "inicio");
  }

  function volverEdicion(){
    mostrarVista("entrada");
  }

  function volverInicio(){
    mostrarVista("inicio");
  }

  function iniciarSimulador(){
    mostrarVista("entrada");
  }

  function iniciarSimuladorCursos(){
    mostrarVista("cursos");
  }

  setupCanvas();
  updateParticles();
  mostrarVista("inicio");
  calcular();

  const cursos = [
    { id:"lenguaje-1", nombre:"Lenguaje y Comunicaci√≥n I", nivel:1, tipo:"obligatorio", creditos:4, requisitos:[] },
    { id:"intro-ingenieria", nombre:"Introducci√≥n a la Ingenier√≠a", nivel:1, tipo:"obligatorio", creditos:3, requisitos:[] },
    { id:"desarrollo-personal", nombre:"Desarrollo Personal y Social", nivel:1, tipo:"obligatorio", creditos:3, requisitos:[] },
    { id:"metodologias-investigacion", nombre:"Metodolog√≠as de la Investigaci√≥n", nivel:1, tipo:"obligatorio", creditos:3, requisitos:[] },
    { id:"etica-civica", nombre:"√âtica C√≠vica", nivel:1, tipo:"obligatorio", creditos:2, requisitos:[] },
    { id:"matematica-basica", nombre:"Matem√°tica B√°sica", nivel:1, tipo:"obligatorio", creditos:5, requisitos:[] },

    { id:"lenguaje-2", nombre:"Lenguaje y Comunicaci√≥n II", nivel:2, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"lenguaje-1" }] },
    { id:"procesos-sociales", nombre:"Procesos Sociales y Pol√≠ticos", nivel:2, tipo:"obligatorio", creditos:3, requisitos:[] },
    { id:"algebra-lineal", nombre:"√Ålgebra Lineal", nivel:2, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"matematica-basica" }] },
    { id:"economia-empresa", nombre:"Econom√≠a y Empresa", nivel:2, tipo:"obligatorio", creditos:3, requisitos:[] },
    { id:"temas-filosofia", nombre:"Temas de Filosof√≠a", nivel:2, tipo:"obligatorio", creditos:3, requisitos:[] },
    { id:"calculo-1", nombre:"C√°lculo I", nivel:2, tipo:"obligatorio", creditos:5, requisitos:[{ tipo:"curso", id:"matematica-basica" }] },

    { id:"sistemas-organizacionales", nombre:"Sistemas Organizacionales", nivel:3, tipo:"obligatorio", creditos:2, requisitos:[{ tipo:"curso", id:"economia-empresa" }] },
    { id:"diseno-cad", nombre:"Dise√±o Asistido por el Computador", nivel:3, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"algebra-lineal" }] },
    { id:"ia-aplicada", nombre:"Inteligencia Artificial Aplicada", nivel:3, tipo:"obligatorio", creditos:3, requisitos:[] },
    { id:"fisica-1", nombre:"F√≠sica I", nivel:3, tipo:"obligatorio", creditos:5, requisitos:[{ tipo:"curso", id:"calculo-1" }] },
    { id:"quimica-general", nombre:"Qu√≠mica General", nivel:3, tipo:"obligatorio", creditos:4, requisitos:[] },
    { id:"calculo-2", nombre:"C√°lculo II", nivel:3, tipo:"obligatorio", creditos:5, requisitos:[{ tipo:"curso", id:"calculo-1" }] },

    { id:"costeo-operaciones", nombre:"Costeo de Operaciones", nivel:4, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"sistemas-organizacionales" }] },
    { id:"fundamentos-programacion", nombre:"Fundamentos de Programaci√≥n", nivel:4, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"ia-aplicada" }] },
    { id:"fisica-2", nombre:"F√≠sica II", nivel:4, tipo:"obligatorio", creditos:5, requisitos:[{ tipo:"curso", id:"fisica-1" }] },
    { id:"estadistica-probabilidad", nombre:"Estad√≠stica y Probabilidad", nivel:4, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"calculo-1" }] },
    { id:"mecanica", nombre:"Mec√°nica", nivel:4, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"fisica-1" }, { tipo:"curso", id:"diseno-cad" }] },
    { id:"calculo-3", nombre:"C√°lculo III", nivel:4, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"calculo-2" }] },

    { id:"io-1", nombre:"Investigaci√≥n de Operaciones I", nivel:5, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"fundamentos-programacion" }] },
    { id:"fundamentos-logistica", nombre:"Fundamentos de Operaciones y Log√≠stica", nivel:5, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"costeo-operaciones" }] },
    { id:"ingenieria-economica", nombre:"Ingenier√≠a Econ√≥mica", nivel:5, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"costeo-operaciones" }] },
    { id:"electricidad-electronica", nombre:"Electricidad y Electr√≥nica", nivel:5, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"fisica-2" }] },
    { id:"ecuaciones-diferenciales", nombre:"Ecuaciones Diferenciales", nivel:5, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"calculo-3" }] },
    { id:"diseno-experimentos", nombre:"Dise√±o de Experimentos", nivel:5, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"estadistica-probabilidad" }] },

    { id:"io-2", nombre:"Investigaci√≥n de Operaciones II", nivel:6, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"io-1" }] },
    { id:"ergonomia", nombre:"Ergonom√≠a y Dise√±o del Trabajo", nivel:6, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"estadistica-probabilidad" }] },
    { id:"innovacion-ingenieria", nombre:"Innovaci√≥n en Ingenier√≠a", nivel:6, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"electricidad-electronica" }, { tipo:"curso", id:"mecanica" }] },
    { id:"planeamiento-control", nombre:"Planeamiento y Control de Operaciones", nivel:6, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"fundamentos-logistica" }] },
    { id:"procesos-industriales", nombre:"Procesos Industriales", nivel:6, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"quimica-general" }, { tipo:"curso", id:"fisica-2" }] },

    { id:"ingenieria-financiera", nombre:"Ingenier√≠a Financiera", nivel:7, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"ingenieria-economica" }] },
    { id:"diseno-instalaciones", nombre:"Dise√±o de Instalaciones", nivel:7, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"ergonomia" }] },
    { id:"inteligencia-negocios", nombre:"Inteligencia de Negocios", nivel:7, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"nivel", valor:5 }] },
    { id:"modelos-logisticos", nombre:"Modelos de Sistemas Log√≠sticos", nivel:7, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"fundamentos-logistica" }] },
    { id:"calidad", nombre:"Calidad", nivel:7, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"diseno-experimentos" }] },
    { id:"procesos-manufactura", nombre:"Procesos de Manufactura", nivel:7, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"innovacion-ingenieria" }] },

    { id:"simulacion-procesos", nombre:"Simulaci√≥n de Procesos", nivel:8, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"io-2" }] },
    { id:"modelamiento-predictivo", nombre:"Modelamiento Predictivo de Datos", nivel:8, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"inteligencia-negocios" }] },
    { id:"sistemas-gestion", nombre:"Sistemas Integrados de Gesti√≥n", nivel:8, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"calidad" }] },
    { id:"gestion-proyectos", nombre:"Gesti√≥n de Proyectos", nivel:8, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"nivel", valor:6 }] },
    { id:"analisis-problemas", nombre:"An√°lisis de Problemas de Ingenier√≠a", nivel:8, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"modelos-logisticos" }, { tipo:"curso", id:"calidad" }] },
    { id:"automatizacion-industrial", nombre:"Automatizaci√≥n Industrial", nivel:8, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"procesos-manufactura" }] },

    { id:"etica-gestion", nombre:"√âtica y Gesti√≥n Humana", nivel:9, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"proyecto-aplicada-1", nombre:"Proyecto de Ingenier√≠a Aplicada I", nivel:9, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"analisis-problemas" }] },
    { id:"ingenieria-comercial", nombre:"Ingenier√≠a Comercial", nivel:9, tipo:"obligatorio", creditos:3, requisitos:[{ tipo:"curso", id:"modelos-logisticos" }] },

    { id:"proyecto-aplicada-2", nombre:"Proyecto de Ingenier√≠a Aplicada II", nivel:10, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"proyecto-aplicada-1" }, { tipo:"curso", id:"simulacion-procesos" }] },
    { id:"gerencia-estrategica", nombre:"Gerencia Estrat√©gica", nivel:10, tipo:"obligatorio", creditos:4, requisitos:[{ tipo:"curso", id:"ingenieria-financiera" }, { tipo:"curso", id:"ingenieria-comercial" }] },

    { id:"globalizacion", nombre:"Globalizaci√≥n, Capitalismo y Ciencia en el Mundo Contempor√°neo", nivel:6, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:80 }] },
    { id:"taller-liderazgo", nombre:"Taller de Liderazgo", nivel:6, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:80 }] },
    { id:"programacion-ingenieria", nombre:"Programaci√≥n para Ingenier√≠a", nivel:6, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:80 }] },

    { id:"sistemas-info", nombre:"Sistemas de Informaci√≥n Gerencial", nivel:7, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:100 }] },
    { id:"taller-habilidades", nombre:"Taller de Habilidades Gerenciales", nivel:7, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:100 }] },

    { id:"tecnologia-industrial", nombre:"Tecnolog√≠a Industrial", nivel:8, tipo:"electivo", creditos:3, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"intro-bd", nombre:"Introducci√≥n a Sistemas de Gesti√≥n de Bases de Datos", nivel:8, tipo:"electivo", creditos:3, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"creatividad", nombre:"Creatividad, Innovaci√≥n y Emprendimiento", nivel:8, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"lean-six-sigma", nombre:"Lean Six Sigma", nivel:8, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"gestion-servicios", nombre:"Gesti√≥n de Operaciones de Servicios", nivel:8, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },

    { id:"gestion-proyectos-diseno", nombre:"Gesti√≥n de Proyectos de Dise√±o", nivel:9, tipo:"electivo", creditos:3, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"supply-chain", nombre:"Supply Chain Management", nivel:9, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"compras-abastecimiento", nombre:"Compras y Gesti√≥n del Abastecimiento", nivel:9, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"formulacion-proyectos", nombre:"Formulaci√≥n y Evaluaci√≥n de Proyectos", nivel:9, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"metodologias-agiles", nombre:"Metodolog√≠as √Ågiles", nivel:9, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"comercio-internacional", nombre:"Gesti√≥n del Comercio Internacional", nivel:9, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"diseno-prototipado", nombre:"Dise√±o y Prototipado", nivel:9, tipo:"electivo", creditos:3, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"machine-learning", nombre:"Machine Learning", nivel:9, tipo:"electivo", creditos:3, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"herramientas-informaticas", nombre:"Herramientas Inform√°ticas", nivel:9, tipo:"electivo", creditos:3, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"sostenibilidad-industrial", nombre:"Sostenibilidad Industrial", nivel:9, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },

    { id:"transformacion-digital", nombre:"Transformaci√≥n Digital", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"estrategia-inteligencia", nombre:"Estrategia de Inteligencia Empresarial", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"juego-negocios", nombre:"Juego de Negocios", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"direccion-proyectos", nombre:"Direcci√≥n en Implementaci√≥n de Proyectos", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"diseno-proyectos", nombre:"Dise√±o de Proyectos Sostenibles", nivel:10, tipo:"electivo", creditos:4, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"tecnologias-programacion", nombre:"Tecnolog√≠as de Programaci√≥n", nivel:10, tipo:"electivo", creditos:4, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"rpa", nombre:"Robotic Process Automation", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"nivel", valor:7 }] },
    { id:"procesos-logisticos-erp", nombre:"Procesos Log√≠sticos ERP", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"ingenieria-transporte", nombre:"Ingenier√≠a del Transporte y Distribuci√≥n", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"gestion-recursos", nombre:"Gesti√≥n de Recursos", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"gestion-riesgos", nombre:"Gesti√≥n de Riesgos y Portafolios", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"gerencia-b2b", nombre:"Gerencia B2B", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] },
    { id:"marketing-digital", nombre:"Herramientas de Marketing Digital", nivel:10, tipo:"electivo", creditos:3, requisitos:[{ tipo:"creditos", valor:120 }] }
  ];

  const cursosPorId = cursos.reduce((acc, curso) => {
    acc[curso.id] = curso;
    return acc;
  }, {});

  function renderChecklist(){
    const contenedor = document.getElementById("courseChecklist");
    const tipos = [
      { key:"obligatorio", label:"üìò Cursos obligatorios" },
      { key:"electivo", label:"üéì Cursos electivos" }
    ];

    contenedor.innerHTML = tipos.map((tipo) => {
      const cursosTipo = cursos.filter(curso => curso.tipo === tipo.key);
      const niveles = [...new Set(cursosTipo.map(curso => curso.nivel))].sort((a,b) => a - b);

      const cards = niveles.map(nivel => {
        const cursosNivel = cursosTipo.filter(curso => curso.nivel === nivel);
        const items = cursosNivel.map(curso => `
          <label class="course-item">
            <input type="checkbox" data-curso-id="${curso.id}">
            <div class="course-meta">
              <span>${curso.nombre}</span>
              <small>${curso.creditos} cr√©ditos ¬∑ ${formatearRequisitos(curso)}</small>
            </div>
          </label>
        `).join("");

        return `
          <div class="course-card">
            <h4>Nivel ${nivel}</h4>
            <div class="checkbox-grid">
              ${items}
            </div>
          </div>
        `;
      }).join("");

      return `
        <div class="course-card">
          <h3>${tipo.label}</h3>
          ${cards}
        </div>
      `;
    }).join("");
  }

  function formatearRequisitos(curso){
    if(!curso.requisitos.length){
      return "Sin requisitos";
    }
    const partes = curso.requisitos.map(req => {
      if(req.tipo === "curso"){
        return cursosPorId[req.id]?.nombre || "Curso previo";
      }
      if(req.tipo === "creditos"){
        return `Cr√©ditos aprobados: ${req.valor}`;
      }
      if(req.tipo === "nivel"){
        return `Culminar nivel ${req.valor}`;
      }
      return "Requisito";
    });
    const lista = partes.map(parte => `<li>${parte}</li>`).join("");
    return `Requisitos:<ul class="req-list">${lista}</ul>`;
  }

  function obtenerCursosAprobados(){
    const checks = document.querySelectorAll("#courseChecklist input[type='checkbox']");
    return new Set([...checks].filter(check => check.checked).map(check => check.dataset.cursoId));
  }

  function calcularNivelCiclo(aprobados){
    const obligatorios = cursos.filter(curso => curso.tipo === "obligatorio");
    const niveles = [...new Set(obligatorios.map(curso => curso.nivel))].sort((a, b) => a - b);
    let nivelCompletado = 0;
    niveles.forEach(nivel => {
      const cursosNivel = obligatorios.filter(curso => curso.nivel === nivel);
      const completado = cursosNivel.every(curso => aprobados.has(curso.id));
      if(completado){
        nivelCompletado = nivel;
      }
    });
    const maxNivel = niveles[niveles.length - 1] || 0;
    const nivelCiclo = nivelCompletado >= maxNivel ? maxNivel : Math.max(1, nivelCompletado + 1);
    const inputNivel = document.getElementById("nivelCulminado");
    inputNivel.value = nivelCiclo;
    return { nivelCiclo, nivelCompletado };
  }

  function calcularCreditosAprobados(){
    const aprobados = obtenerCursosAprobados();
    const total = [...aprobados].reduce((acc, id) => acc + (cursosPorId[id]?.creditos || 0), 0);
    const inputCreditos = document.getElementById("creditosAprobados");
    inputCreditos.value = total;
    return total;
  }

  function requisitosCumplidos(curso, aprobados, creditos, nivelCompletado){
    return curso.requisitos.every(req => {
      if(req.tipo === "curso"){
        return aprobados.has(req.id);
      }
      if(req.tipo === "creditos"){
        return creditos >= req.valor;
      }
      if(req.tipo === "nivel"){
        return nivelCompletado >= req.valor;
      }
      return false;
    });
  }

  function simularCursos(){
    const aprobados = obtenerCursosAprobados();
    const creditos = calcularCreditosAprobados();
    const { nivelCompletado } = calcularNivelCiclo(aprobados);

    const disponibles = cursos.filter(curso => !aprobados.has(curso.id) && requisitosCumplidos(curso, aprobados, creditos, nivelCompletado));
    const obligatorios = disponibles.filter(curso => curso.tipo === "obligatorio");
    const electivos = disponibles.filter(curso => curso.tipo === "electivo");

    renderResultados("resultadoObligatorios", "emptyObligatorios", obligatorios);
    renderResultados("resultadoElectivos", "emptyElectivos", electivos);
  }

  function renderResultados(listaId, emptyId, cursosDisponibles){
    const lista = document.getElementById(listaId);
    const empty = document.getElementById(emptyId);
    if(!cursosDisponibles.length){
      lista.innerHTML = "";
      empty.style.display = "block";
      return;
    }

    empty.style.display = "none";
    lista.innerHTML = cursosDisponibles.map(curso => `
      <li>
        <strong>${curso.nombre}</strong>
        <div class="course-tags">
          <span>Nivel ${curso.nivel}</span>
          <span>${curso.tipo === "obligatorio" ? "Obligatorio" : "Electivo"}</span>
          <span>${curso.creditos} cr√©ditos</span>
        </div>
        <div class="course-reqs">${formatearRequisitos(curso)}</div>
      </li>
    `).join("");
  }

  function limpiarCursos(){
    document.querySelectorAll("#courseChecklist input[type='checkbox']").forEach(check => {
      check.checked = false;
    });
    document.getElementById("creditosAprobados").value = 0;
    document.getElementById("nivelCulminado").value = 1;
    renderResultados("resultadoObligatorios", "emptyObligatorios", []);
    renderResultados("resultadoElectivos", "emptyElectivos", []);
  }

  renderChecklist();
  document.getElementById("courseChecklist").addEventListener("change", simularCursos);
  simularCursos();
</script>
</body>
</html>
